<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geofenced Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background-color: #000000;
            position: relative;
            overflow: hidden;
        }
        h2 {
            padding: 15px;
            background-color: #007bff;
            color: white;
            margin: 0;
        }
        #map {
            height: 80vh;
            width: 95%;
            margin: 10px auto;
            border-radius: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        #overlay {
            position: fixed;
            bottom: -80vh;
            left: 0;
            right: 0;
            height: 80vh;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            transition: bottom 0.5s ease-in-out;
            z-index: 1000;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            padding-bottom: 20px;
        }
        #overlay.show {
            bottom: 0;
        }
        .overlay-content {
            padding: 20px;
            text-align: left;
            max-width: 90%;
            margin: 0 auto;
        }
        .overlay-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
        }
        .overlay-image {
            width: 100%;
            margin: 15px 0;
            border-radius: 10px;
            max-height: 250px;
            object-fit: cover;
        }
        .overlay-description {
            font-size: 16px;
            line-height: 1.6;
            margin-top: 15px;
        }
        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 1001;
        }
        .pull-handle {
            width: 60px;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 3px;
            margin: 10px auto;
            cursor: pointer;
        }
        .active-geofence {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% {
                opacity: 0.6;
                transform: scale(1);
            }
            50% {
                opacity: 0.9;
                transform: scale(1.05);
            }
            100% {
                opacity: 0.6;
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <h2>Geofenced Map</h2>
    <div id="map"></div>
    <div id="overlay">
        <div class="pull-handle" id="pull-handle"></div>
        <button class="close-button" id="close-button">✕</button>
        <div class="overlay-content" id="overlay-content">
            <!-- Content will be dynamically populated -->
        </div>
    </div>
    <script>
        // Initialize map
        let map = L.map('map').setView([17.734861, 83.338056], 14); // Default to Queen Elizabeth location
        let currentZoom = 14; // Store current zoom level
        let userMarker = null; // Variable to track current user marker
        let currentGeofence = null; // Track current geofence
        let geofenceCircles = []; // Store references to geofence circles
        
        // Set up the map layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Store zoom level changes
        map.on('zoomend', function() {
            currentZoom = map.getZoom();
        });
        
        // Define multiple geofences with their details
        const geofences = [
            {
                id: 'queen_elizabeth',
                name: 'Queen Elizabeth',
                center: [17.734861, 83.338056],
                radius: 10, // meters
                color: 'red',
                description: 'You are at Queen Elizabeth. This historic site features beautiful architecture and gardens.',
                image: 'https://example.com/queen_elizabeth.jpg' // Replace with actual image URL
            },
            {
                id: 'central_park',
                name: 'Central Park',
                center: [17.73418342262189, 83.33759382126067], // Example coordinates - replace with actual
                radius: 15, // meters
                color: 'blue',
                description: 'On your left is Jalebi Haleem. The finest barber in whole of the west',
                image: 'https://example.com/central_park.jpg' // Replace with actual image URL
            },
            {
                id: 'toyota_park',
                name: 'Toyota Park',
                center: [17.73437430705774, 83.3383470880571], // Example coordinates - replace with actual
                radius: 15, // meters
                color: 'black',
                description: 'Welcome to black Toyota Park. Enjoy the rental black toyota. Mark of pride and excellence of politicians for cneturies',
                image: 'https://example.com/central_park.jpg' // Replace with actual image URL
            },
            {
                id: 'galilee_clone',
                name: 'Galilee Clone',
                center: [17.735214839308682, 83.33769462017001], // Example coordinates - replace with actual
                radius: 15, // meters
                color: 'pink',
                description: 'Welcome to Jalebi Haleem. Enjoy the finest jalebi in whole of the west',
                image: 'https://example.com/central_park.jpg' // Replace with actual image URL
            }
            // Add more geofences as needed
        ];
        
        // Create circles for all geofences
        geofenceCircles = geofences.map(geofence => {
            return L.circle(geofence.center, {
                color: geofence.color,
                fillColor: geofence.color,
                fillOpacity: 0.2,
                radius: geofence.radius,
                id: geofence.id
            }).addTo(map);
        });
        
        // Function to show overlay with geofence information
        function showGeofenceOverlay(geofence) {
            const overlayContent = document.getElementById('overlay-content');
            
            // If we're already showing this geofence, don't reset the overlay
            if (currentGeofence && currentGeofence.id === geofence.id) {
                return;
            }
            
            currentGeofence = geofence;
            
            // Update overlay content
            let content = `
                <div class="overlay-title">${geofence.name}</div>
            `;
            
            if (geofence.image) {
                content += `<img src="${geofence.image}" alt="${geofence.name}" class="overlay-image">`;
            }
            
            if (geofence.description) {
                content += `<div class="overlay-description">${geofence.description}</div>`;
            }
            
            overlayContent.innerHTML = content;
            document.getElementById('overlay').classList.add('show');
            
            // Highlight the active geofence
            resetGeofenceHighlights();
            highlightGeofence(geofence.id);
        }
        
        // Function to reset all geofence highlights
        function resetGeofenceHighlights() {
            geofenceCircles.forEach(circle => {
                circle.getElement().classList.remove('active-geofence');
            });
        }
        
        // Function to highlight a specific geofence
        function highlightGeofence(geofenceId) {
            const index = geofences.findIndex(g => g.id === geofenceId);
            if (index !== -1) {
                geofenceCircles[index].getElement().classList.add('active-geofence');
            }
        }
        
        // Function to dismiss overlay
        function dismissOverlay() {
            document.getElementById('overlay').classList.remove('show');
            setTimeout(() => {
                currentGeofence = null;
                resetGeofenceHighlights();
            }, 500); // Wait for transition to complete
        }
        
        // Set up event listeners for overlay
        document.getElementById('close-button').addEventListener('click', dismissOverlay);
        
        // Pull handle functionality for sliding down
        const pullHandle = document.getElementById('pull-handle');
        let startY = 0;
        let currentY = 0;
        
        pullHandle.addEventListener('touchstart', function(e) {
            startY = e.touches[0].clientY;
        });
        
        pullHandle.addEventListener('touchmove', function(e) {
            currentY = e.touches[0].clientY;
            if (currentY - startY > 50) { // If pulled down more than 50px
                dismissOverlay();
            }
        });
        
        // Check if user is within any geofence
        function checkGeofences(userPosition) {
            const userLat = userPosition.coords.latitude;
            const userLng = userPosition.coords.longitude;
            const userLocation = [userLat, userLng];
            
            // Check each geofence
            for (const geofence of geofences) {
                const distance = map.distance(userLocation, geofence.center);
                if (distance <= geofence.radius) {
                    showGeofenceOverlay(geofence);
                    return; // Show only the first matching geofence
                }
            }
            
            // If user is not in any geofence and overlay is showing, dismiss it
            if (currentGeofence && document.getElementById('overlay').classList.contains('show')) {
                dismissOverlay();
            }
        }
        
        // Handle location updates
        function handleLocationUpdate(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Remove previous marker if exists
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            // Add new marker without popup
            userMarker = L.marker([lat, lng]).addTo(map);
            
            // Update map view, maintaining current zoom level
            map.setView([lat, lng], currentZoom);
            
            // Check if user is in any geofence
            checkGeofences(position);
        }
        
        // Error handler with specific messages
        function errorHandler(error) {
            let errorMessage = "Location error occurred.";
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "Location access was denied. Please enable location permissions in your browser settings.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Location information is unavailable. Please check your device's GPS.";
                    break;
                case error.TIMEOUT:
                    errorMessage = "Location request timed out. Please try again.";
                    break;
            }
            
            alert(errorMessage);
            console.warn("Error obtaining location", error);
        }
        
        // Start geolocation tracking
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(handleLocationUpdate, errorHandler, { 
                enableHighAccuracy: true,
                maximumAge: 0, 
                timeout: 30000 // 30 seconds timeout
            });
        } else {
            alert("Geolocation is not supported by your browser.");
        }
    </script>
</body>
</html>
